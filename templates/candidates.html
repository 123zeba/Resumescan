<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved Candidates - AI Resume Analyzer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/static/style.css">

</head>
<body>
    <div class="container">
        <h1><i class="fa-solid fa-users"></i> Saved Candidate Records</h1>
        <a href="/" class="back-link"><i class="fa-solid fa-arrow-left"></i> Back to Analyzer</a>

        {% if error %}
            <div class="error-message">
                <strong>Error:</strong> Could not load candidate data. {{ error }}
            </div>
        {% endif %}

        <!-- Filter and Sort Controls -->
        <div class="controls-container" {% if not candidates %}style="display: none;"{% endif %}>
            <input type="text" id="filterInput" placeholder="Filter by position...">
            <button id="sortBtn"><i class="fa-solid fa-arrow-down-9-1"></i> Sort by Score (High-Low)</button>
        </div>
        
        <div id="candidates-container">
              {% include 'candidate_table.html' %}
        </div>
        
        <!-- Pagination -->
        <div class="pagination-container" {% if not candidates or candidates|length <= 5 %}style="display: none;"{% endif %}>
            <ul id="pagination" class="pagination">
                <!-- Page numbers will be generated by JavaScript -->
            </ul>
        </div>
        
        <div id="no-results" style="display: none;">
            <p>No candidates match the current filter.</p>
        </div>

        <div class="no-candidates" {% if candidates %}style="display: none;"{% endif %}>
            <p>No candidates have been saved to the database yet.</p>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">Ã—</span>
            <h2>Send Interview Invitation</h2>
            <div id="modal-loader" style="display: none; text-align: center; padding: 20px;">
                <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
                <p>Fetching details...</p>
            </div>
            <form id="emailForm" style="display: none;">
                <div class="form-group">
                    <label for="emailTo">To:</label>
                    <input type="email" id="emailTo" required>
                </div>
                <div class="form-group">
                    <label for="emailSubject">Subject:</label>
                    <input type="text" id="emailSubject" required>
                </div>
                <div class="form-group">
                    <label for="emailBody">Body:</label>
                    <textarea id="emailBody" rows="15" required></textarea>
                </div>
                <button type="submit" id="sendFinalEmailBtn" class="btn btn-primary">
                    <i class="fa-solid fa-share"></i> Send Email
                </button>
                <small id="modalEmailStatus"></small>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('candidates-container');
    if (!container) return;

    let tableBody = container.querySelector('.candidates-table tbody');
    if (!tableBody) return;

    let originalRows = Array.from(tableBody.querySelectorAll('tr'));
    const filterInput = document.getElementById('filterInput');
    const sortBtn = document.getElementById('sortBtn');
    const noResultsDiv = document.getElementById('no-results');
    const paginationContainer = document.querySelector('.pagination-container');
    const paginationUl = document.getElementById('pagination');
    
    const rowsPerPage = 5;
    let currentPage = 1;
    let sortState = 'desc';
    let currentRows = [...originalRows];

    function displayPage(page) {
        currentPage = page;
        tableBody = container.querySelector('.candidates-table tbody');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';

        const startIndex = (page - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const pageRows = currentRows.slice(startIndex, endIndex);

        pageRows.forEach(row => tableBody.appendChild(row));
        setupPagination();
    }

    function setupPagination() {
        paginationUl.innerHTML = '';
        const pageCount = Math.ceil(currentRows.length / rowsPerPage);

        if (pageCount <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        paginationContainer.style.display = 'flex';

        const prevLi = document.createElement('li');
        prevLi.innerHTML = `<a class="prev ${currentPage === 1 ? 'disabled' : ''}">Previous</a>`;
        prevLi.addEventListener('click', () => {
            if (currentPage > 1) displayPage(currentPage - 1);
        });
        paginationUl.appendChild(prevLi);

        for (let i = 1; i <= pageCount; i++) {
            const li = document.createElement('li');
            li.innerHTML = `<a class="${i === currentPage ? 'active' : ''}">${i}</a>`;
            li.addEventListener('click', () => displayPage(i));
            paginationUl.appendChild(li);
        }

        const nextLi = document.createElement('li');
        nextLi.innerHTML = `<a class="next ${currentPage === pageCount ? 'disabled' : ''}">Next</a>`;
        nextLi.addEventListener('click', () => {
            if (currentPage < pageCount) displayPage(currentPage + 1);
        });
        paginationUl.appendChild(nextLi);
    }

    function updateView() {
        const filterText = filterInput.value.toLowerCase();
        currentRows = originalRows.filter(row => {
            const positionText = row.cells[1].textContent.toLowerCase();
            return positionText.includes(filterText);
        });

        if (sortState !== 'default') {
            currentRows.sort((a, b) => {
                const scoreA = parseInt(a.cells[2].textContent, 10);
                const scoreB = parseInt(b.cells[2].textContent, 10);
                return sortState === 'asc' ? scoreA - scoreB : scoreB - scoreA;
            });
        }
        
        noResultsDiv.style.display = currentRows.length === 0 ? 'block' : 'none';
        displayPage(1);
    }

    filterInput.addEventListener('keyup', updateView);

    sortBtn.addEventListener('click', () => {
        if (sortState === 'desc') {
            sortState = 'asc';
            sortBtn.innerHTML = '<i class="fa-solid fa-arrow-up-1-9"></i> Sort by Score (Low-High)';
        } else if (sortState === 'asc') {
            sortState = 'default';
            sortBtn.innerHTML = '<i class="fa-solid fa-clock-rotate-left"></i> Reset to Default Order';
        } else {
            sortState = 'desc';
            sortBtn.innerHTML = '<i class="fa-solid fa-arrow-down-9-1"></i> Sort by Score (High-Low)';
        }
        updateView();
    });

    // --- MODAL AND ACTION BUTTON LOGIC ---
    const modal = document.getElementById('emailModal');
    const modalLoader = document.getElementById('modal-loader');
    const modalForm = document.getElementById('emailForm');
    const closeModalBtn = modal.querySelector('.close-btn');
    const emailToInput = document.getElementById('emailTo');
    const emailSubjectInput = document.getElementById('emailSubject');
    const emailBodyInput = document.getElementById('emailBody');
    const sendFinalEmailBtn = document.getElementById('sendFinalEmailBtn');
    const modalEmailStatus = document.getElementById('modalEmailStatus');

    async function openEmailModal(candidateId, candidateName) {
        modal.style.display = 'block';
        modalForm.style.display = 'none';
        modalLoader.style.display = 'block';
        modalEmailStatus.textContent = '';
        
        try {
            const response = await fetch(`/get-email-details/${candidateId}`);
            const data = await response.json();

            if (!response.ok) throw new Error(data.detail);

            emailToInput.value = data.email || '';
            emailSubjectInput.value = data.subject;
            emailBodyInput.value = data.body;

            if (!data.email) {
                alert(`Could not automatically find an email for ${candidateName}. Please enter it manually.`);
            }

        } catch (error) {
            console.error('Error fetching email details:', error);
            alert(`Error: ${error.message}`);
            closeModal();
        } finally {
            modalLoader.style.display = 'none';
            modalForm.style.display = 'block';
        }
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    // Use Event Delegation for ALL action buttons (delete and email)
    container.addEventListener('click', async (event) => {
        const deleteButton = event.target.closest('.delete-btn');
        const emailButton = event.target.closest('.email-btn');

        if (deleteButton) {
            const candidateId = deleteButton.dataset.id;
            const candidateRow = document.getElementById(`candidate-row-${candidateId}`);
            const candidateName = candidateRow.cells[0].textContent;

            if (confirm(`Are you sure you want to delete the record for "${candidateName}"? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`/candidates/${candidateId}`, { method: 'DELETE' });
                    if (response.ok) {
                        const rowIndex = originalRows.findIndex(row => row.id === `candidate-row-${candidateId}`);
                        if(rowIndex > -1) originalRows.splice(rowIndex, 1);
                        updateView();
                    } else {
                        const errorData = await response.json();
                        alert(`Failed to delete candidate: ${errorData.detail || 'Unknown server error'}`);
                    }
                } catch (error) {
                    console.error('Error deleting candidate:', error);
                    alert('An error occurred while trying to delete the candidate.');
                }
            }
        } else if (emailButton) {
            const candidateId = emailButton.dataset.id;
            const candidateName = emailButton.dataset.name;
            openEmailModal(candidateId, candidateName);
        }
    });

    closeModalBtn.addEventListener('click', closeModal);

    modalForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        sendFinalEmailBtn.disabled = true;
        sendFinalEmailBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
        modalEmailStatus.textContent = 'Sending...';
        modalEmailStatus.style.color = 'var(--primary-color)';

        const payload = {
            to_email: emailToInput.value,
            subject: emailSubjectInput.value,
            body: emailBodyInput.value
        };

        try {
            const response = await fetch('/send-candidate-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.detail);
            
            modalEmailStatus.textContent = 'Email sent successfully!';
            modalEmailStatus.style.color = 'var(--success-color)';
            setTimeout(closeModal, 2000);

        } catch (error) {
            modalEmailStatus.textContent = `Error: ${error.message}`;
            modalEmailStatus.style.color = 'var(--error-color)';
        } finally {
            sendFinalEmailBtn.disabled = false;
            sendFinalEmailBtn.innerHTML = '<i class="fa-solid fa-share"></i> Send Email';
        }
    });

    window.addEventListener('click', (event) => {
        if (event.target == modal) {
            closeModal();
        }
    });

    // --- INITIAL LOAD ---
    updateView();
});
</script>
</body>
</html>