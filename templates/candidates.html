<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved Candidates - AI Resume Analyzer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- REMOVE THE <style> BLOCK AND ADD THIS LINK -->
    <link rel="stylesheet" href="/static/style.css">

</head>
<body>
    <div class="container">
        <h1><i class="fa-solid fa-users"></i> Saved Candidate Records</h1>
        <a href="/" class="back-link"><i class="fa-solid fa-arrow-left"></i> Back to Analyzer</a>

        {% if error %}
            <div class="error-message">
                <strong>Error:</strong> Could not load candidate data. {{ error }}
            </div>
        {% endif %}

        <!-- NEW: Filter and Sort Controls -->
        <div class="controls-container" {% if not candidates %}style="display: none;"{% endif %}>
            <input type="text" id="filterInput" placeholder="Filter by position...">
            <button id="sortBtn"><i class="fa-solid fa-arrow-down-9-1"></i> Sort by Score (High-Low)</button>
        </div>

        <table id="candidatesTable" {% if not candidates %}style="display: none;"{% endif %}>
            <thead>
                <tr>
                    <th>Candidate Name</th>
                    <th>Position Applied For</th>
                    <th>Match Score</th>
                    <th>Application Date</th>
                    <th>Download CV</th>
                    <th>Download Report</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for candidate in candidates %}
                <tr id="candidate-row-{{ candidate.id }}">
                    <td>{{ candidate.name }}</td>
                    <td>{{ candidate.position }}</td>
                    <td>
                        <span class="score 
                            {% if candidate.score >= 80 %}score-high
                            {% elif candidate.score >= 60 %}score-medium
                            {% else %}score-low
                            {% endif %}">
                            {{ candidate.score }}%
                        </span>
                    </td>
                    <td>{{ candidate.application_date }}</td>
                    <td>
                        {% if candidate.cv_filepath %}
                            <a href="/download-cv/{{ candidate.id }}" class="cv-download-link" title="Download Original CV">
                                <i class="fa-solid fa-file-arrow-down"></i> CV
                            </a>
                        {% else %}
                            <span class="no-cv">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if candidate.report_filepath %}
                            <a href="/download-report/{{ candidate.id }}" class="cv-download-link" title="Download Analysis Report">
                                <i class="fa-solid fa-file-pdf"></i> Report
                            </a>
                        {% else %}
                            <span class="no-cv">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="delete-btn" data-id="{{ candidate.id }}" title="Delete Candidate">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div id="no-results" style="display: none;">
            <p>No candidates match the current filter.</p>
        </div>

        <div class="no-candidates" {% if candidates %}style="display: none;"{% endif %}>
            <p>No candidates have been saved to the database yet.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tableBody = document.querySelector('#candidatesTable tbody');
            if (!tableBody) return;

            const originalRows = Array.from(tableBody.querySelectorAll('tr'));
            const filterInput = document.getElementById('filterInput');
            const sortBtn = document.getElementById('sortBtn');
            const noResultsDiv = document.getElementById('no-results');
            
            let sortState = 'desc'; // 'desc', 'asc', 'default'

            // --- FILTER FUNCTIONALITY ---
            filterInput.addEventListener('keyup', () => {
                const filterText = filterInput.value.toLowerCase();
                let visibleRows = 0;
                
                tableBody.querySelectorAll('tr').forEach(row => {
                    const positionCell = row.cells[1];
                    const positionText = positionCell.textContent.toLowerCase();
                    
                    if (positionText.includes(filterText)) {
                        row.style.display = '';
                        visibleRows++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                noResultsDiv.style.display = visibleRows === 0 ? 'block' : 'none';
            });

            // --- SORT FUNCTIONALITY ---
            sortBtn.addEventListener('click', () => {
                // Cycle through states: desc -> asc -> default -> desc
                if (sortState === 'desc') {
                    sortState = 'asc';
                    sortBtn.innerHTML = '<i class="fa-solid fa-arrow-up-1-9"></i> Sort by Score (Low-High)';
                } else if (sortState === 'asc') {
                    sortState = 'default';
                    sortBtn.innerHTML = '<i class="fa-solid fa-clock-rotate-left"></i> Reset to Default Order';
                } else {
                    sortState = 'desc';
                    sortBtn.innerHTML = '<i class="fa-solid fa-arrow-down-9-1"></i> Sort by Score (High-Low)';
                }
                performSort();
            });

            function performSort() {
                const rowsToSort = Array.from(tableBody.querySelectorAll('tr'));

                if (sortState === 'default') {
                    // Re-append rows in their original order
                    originalRows.forEach(row => tableBody.appendChild(row));
                    return;
                }

                rowsToSort.sort((a, b) => {
                    const scoreA = parseInt(a.cells[2].textContent, 10);
                    const scoreB = parseInt(b.cells[2].textContent, 10);

                    if (sortState === 'asc') {
                        return scoreA - scoreB;
                    } else { // 'desc'
                        return scoreB - scoreA;
                    }
                });

                // Re-append sorted rows to the table body
                rowsToSort.forEach(row => tableBody.appendChild(row));
            }

            // --- DELETE FUNCTIONALITY (with event delegation) ---
            tableBody.addEventListener('click', async (event) => {
                const deleteButton = event.target.closest('.delete-btn');
                if (!deleteButton) return;

                const candidateId = deleteButton.dataset.id;
                const candidateRow = document.getElementById(`candidate-row-${candidateId}`);
                const candidateName = candidateRow.cells[0].textContent;

                if (confirm(`Are you sure you want to delete the record for "${candidateName}"? This action cannot be undone.`)) {
                    try {
                        const response = await fetch(`/candidates/${candidateId}`, { method: 'DELETE' });

                        if (response.ok) {
                            candidateRow.style.transition = 'opacity 0.5s ease';
                            candidateRow.style.opacity = '0';
                            setTimeout(() => {
                                candidateRow.remove();
                                // Check if table is now empty
                                if (tableBody.rows.length === 0) {
                                    document.querySelector('.controls-container').style.display = 'none';
                                    document.querySelector('#candidatesTable').style.display = 'none';
                                    document.querySelector('.no-candidates').style.display = 'block';
                                }
                            }, 500);
                        } else {
                            const errorData = await response.json();
                            alert(`Failed to delete candidate: ${errorData.detail || 'Unknown server error'}`);
                        }
                    } catch (error) {
                        console.error('Error deleting candidate:', error);
                        alert('An error occurred while trying to delete the candidate.');
                    }
                }
            });
        });
    </script>
</body>
</html>